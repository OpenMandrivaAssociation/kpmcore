From 13beb9931951cf5972e341a871263146d2bdafbe Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Andrius=20=C5=A0tikonas?= <andrius@stikonas.eu>
Date: Mon, 18 Nov 2019 20:42:32 +0200
Subject: [PATCH] Use partx instead of blockdev to update partition table in
 the kernel.

CCBUG: 413883
---
 src/plugins/sfdisk/sfdiskpartitiontable.cpp | 2 +-
 src/util/externalcommand_whitelist.h        | 1 +
 2 files changed, 2 insertions(+), 1 deletion(-)

diff --git a/src/plugins/sfdisk/sfdiskpartitiontable.cpp b/src/plugins/sfdisk/sfdiskpartitiontable.cpp
index 552c973..d4e9db0 100644
--- a/src/plugins/sfdisk/sfdiskpartitiontable.cpp
+++ b/src/plugins/sfdisk/sfdiskpartitiontable.cpp
@@ -57,7 +57,7 @@ bool SfdiskPartitionTable::commit(quint32 timeout)
         ExternalCommand(QStringLiteral("udevadm"), { QStringLiteral("control"), QStringLiteral("--stop-exec-queue") }).run();
 
     ExternalCommand(QStringLiteral("udevadm"), { QStringLiteral("settle"), QStringLiteral("--timeout=") + QString::number(timeout) }).run();
-    ExternalCommand(QStringLiteral("blockdev"), { QStringLiteral("--rereadpt"), m_device->deviceNode() }).run();
+    ExternalCommand(QStringLiteral("partx"), { QStringLiteral("--update"), m_device->deviceNode() }).run();
     ExternalCommand(QStringLiteral("udevadm"), { QStringLiteral("trigger") }).run();
 
     if (m_device->type() == Device::Type::SoftwareRAID_Device)
diff --git a/src/util/externalcommand_whitelist.h b/src/util/externalcommand_whitelist.h
index ba8d087..9ddcb2b 100644
--- a/src/util/externalcommand_whitelist.h
+++ b/src/util/externalcommand_whitelist.h
@@ -25,6 +25,7 @@ QStringLiteral("udevadm"),
 
 //Core programs
 QStringLiteral("blockdev"),
+QStringLiteral("partx"),
 QStringLiteral("sfdisk"),
 QStringLiteral("wipefs"),
 QStringLiteral("lvm"),
